paths:
  segy_files: [../test_data/20200623002546.sgy]
  phase_pick_files: [../test_data//20200623002546_phase_picks.npz]
  infer_segy_files: [../test_data//20200623002546.sgy]
  infer_phase_pick_files: [../test_data//20200623002546_phase_picks.npz]
  noise_segy_files: [] # 空なら混合しない
  out_dir: ./_psn_out

dataset:
  max_trials: 2048
  use_header_cache: true
  verbose: true
  primary_keys: [ffid]
  include_empty_gathers: false
  secondary_key_fixed: false
  train_endian: big
  infer_endian: big

noise:
  mix_prob: 0.0 # 0なら混合しない
  mix_period: 256
  max_retries: 1000

  # sampler は任意。無ければ dataset.primary_keys を使ってデフォルト構築する
  sampler:
    # primary_keys: [ffid] など
    # primary_key_weights: [1.0] など
    use_superwindow: false
    sw_halfspan: 0
    sw_prob: 0.3
    secondary_key_fixed: false

  # detect は任意。無ければ EventDetectConfig のデフォルトを使う
  detect:
    use_envelope: true
    sta_ms: 10.0
    lta_ms: 100.0
    eps: 1e-12
    threshold: 4.0
    min_traces: 8
    min_duration_ms: 20.0
    thr_on: 4.5
    thr_off: 1.5
    min_on_ms: 8.0
    refr_ms: 80.0
    win_ms: 30.0

train:
  device: auto # auto | cpu | cuda | cuda:N
  batch_size: 4
  # gradient_accumulation_steps: 1
  epochs: 10
  lr: 1.0e-4
  # weight_decay: 1.0e-2
  subset_traces: 128
  samples_per_epoch: 256
  psn_sigma: 1.5
  seed: 42
  use_amp: true
  max_norm: 1.0
  num_workers: 0
  loss_scope: all
  # Toggle whether PSN loss mask ANDs label_valid.
  # true  -> trace_valid & label_valid (& mask_bool)
  # false -> trace_valid (& mask_bool), useful when mixing datasets without label_valid.
  use_label_valid_mask: true
  losses:
    - kind: soft_label_ce
      weight: 1.0
      scope: all
      params: {}

# Optional: choose optimizer via timm (default if omitted: torch.optim.AdamW)
# optimizer:
#   name: adamw   # e.g. lion
#   filter_bias_and_bn: false
#   kwargs: {}
#
# optimizer:
#   name: lion
#   filter_bias_and_bn: false
#   kwargs:
#     betas: [0.9, 0.99]

# ema:
#   enabled: true
#   decay: 0.999
#   start_step: 0
#   update_every: 1
#   use_for_infer: true
#   device: cpu  # omit -> same device as model; "cpu" saves VRAM but is slower

transform:
  time_len: 6016
  standardize_eps: 1.0e-8

augment:
  hflip_prob: 0.0
  polarity_prob: 0.0
  space:
    prob: 0.0
    factor_range: [0.90, 1.10]
  time:
    prob: 0.0
    factor_range: [0.95, 1.05]
  freq:
    prob: 0.0
    kinds: [bandpass, lowpass, highpass]
    band: [0.05, 0.45]
    width: [0.10, 0.35]
    roll: 0.02
    restandardize: false
  # Optional: mix in online-sampled noise traces from external SEG-Y files.
  # noise_add:
  #   segy_files:
  #     - /path/to/noise_only_0.sgy
  #     - /path/to/noise_only_1.sgy
  #   prob: 0.3
  #   gain_range: [0.2, 0.8] # Use either gain_range or snr_db_range.
  #   # snr_db_range: [6.0, 18.0]
  #   detect:
  #     threshold: 4.0
  #     min_traces: 8

vis:
  out_subdir: vis
  n: 1

infer:
  batch_size: 1
  max_batches: 4
  subset_traces: 128
  seed: 43
  num_workers: 0

# eval:
#   # Omit this key to inherit train.use_label_valid_mask.
#   use_label_valid_mask: true

ckpt:
  save_best_only: true
  metric: infer_loss
  mode: min

model:
  backbone: resnet18
  # pretrained: false # default
  in_chans: 1
  out_chans: 3
  # stage_strides: null
  # extra_stages: 0
  # extra_stage_strides: null
  # extra_stage_channels: null
  # extra_stage_use_bn: true
  # pre_stages: 0
  # pre_stage_strides: null
  # pre_stage_kernels: null
  # pre_stage_channels: null
  # pre_stage_use_bn: true
  # decoder_channels: [256, 128, 64, 32]
  # decoder_scales: [2, 2, 2, 2]
  # upsample_mode: bilinear
  # attention_type: scse # or null
  # intermediate_conv: true

tracking:
  enabled: true
  exp_name: baseline
  tracking_uri: file:./mlruns
  vis_best_only: true
  vis_max_files: 50
